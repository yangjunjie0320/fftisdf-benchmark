OMP_NUM_THREADS = 32
MKL_NUM_THREADS = 1
PYSCF_MAX_MEMORY = 245760
TMPDIR = /central/scratch/yangjunjie//fftdf-supercell/46923358/
PYSCF_TMPDIR = /central/scratch/yangjunjie//fftdf-supercell/46923358/

/home/junjiey/anaconda3/envs/fftisdf/bin/python
2.7.0
1.14.1
1.26.4
WARNING!
  Very diffused basis functions are found in the basis set. They may lead to severe
  linear dependence and numerical instability.  You can set  cell.exp_to_discard=0.1
  to remove the diffused Gaussians whose exponents are less than 0.1.

WARNING!
  Very diffused basis functions are found in the basis set. They may lead to severe
  linear dependence and numerical instability.  You can set  cell.exp_to_discard=0.1
  to remove the diffused Gaussians whose exponents are less than 0.1.

#INFO: **** input file is /central/home/junjiey/work/fftisdf-benchmark/work/cco-2x2-frac-1-1-2/gth-szv-molopt-sr-20/fftdf-supercell/main.py ****
import os, sys
import numpy, scipy
import pyscf

TMPDIR = os.getenv("TMPDIR", None)
DATA_PATH = os.getenv("DATA_PATH", None)
PYSCF_MAX_MEMORY = os.getenv("PYSCF_MAX_MEMORY", 4000)
PYSCF_MAX_MEMORY = int(PYSCF_MAX_MEMORY)

def main(args):
    from utils import cell_from_poscar
    path = os.path.join(DATA_PATH, args.cell)
    assert os.path.exists(path), "Cell file not found: %s" % path

    c = cell_from_poscar(path)
    c.basis = args.basis
    c.pseudo = args.pseudo
    c.verbose = 0
    c.unit = 'aa'
    # c.exp_to_discard = 0.1
    # c.exp_to_discard = 0.0
    c.max_memory = PYSCF_MAX_MEMORY
    c.ke_cutoff = args.ke_cutoff
    c.build(dump_input=False)

    kmesh = [int(x) for x in args.kmesh.split("-")]
    kmesh = numpy.array(kmesh)
    kpts = c.get_kpts(kmesh)

    pcell = c.copy(deep=True)

    natm = len(pcell.atom)
    atm = []
    for ia in range(natm):
        s = pcell.atom_symbol(ia)
        x = pcell.atom_coord(ia, unit='A')
        atm.append([s, x])

    from pyscf.lib.parameters import BOHR
    lvx = pcell.lattice_vectors() * BOHR

    from pyscf.isdf.isdf_tools_cell import build_supercell_with_partition
    scell, group = build_supercell_with_partition(
        atm, lvx, spin=0, charge=0, mesh=None, Ls=kmesh,
        partition=None, basis=args.basis,
        pseudo=args.pseudo, ke_cutoff=args.ke_cutoff,
        max_memory=PYSCF_MAX_MEMORY, 
        precision=1e-12, 
        use_particle_mesh_ewald=True,
        verbose=4,
    )

    from pyscf.pbc.df.fft import FFTDF
    df_obj = FFTDF(scell)
    df_obj.verbose = 10

    from utils import get_jk_time
    kmesh = None
    tmp = os.path.join(TMPDIR, "fftdf.chk")
    os.system("touch %s" % tmp)
    
    get_jk_time(scell, kmesh=kmesh, df_obj=df_obj, tmp=tmp)

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--cell", type=str, default="diamond-prim.vasp")
    parser.add_argument("--kmesh", type=str, default="2-2-2")
    parser.add_argument("--ke_cutoff", type=float, default=200)
    parser.add_argument("--basis", type=str, default="gth-dzvp-molopt-sr")
    parser.add_argument("--pseudo", type=str, default="gth-pade")

    args = parser.parse_args()
    main(args)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='hpc-54-28.cm.cluster', release='5.14.0-362.24.1.el9_3.x86_64', version='#1 SMP PREEMPT_DYNAMIC Thu Feb 15 07:18:13 EST 2024', machine='x86_64')  Threads 32
Python 3.12.3 | packaged by conda-forge | (main, Apr 15 2024, 18:38:13) [GCC 12.3.0]
numpy 1.26.4  scipy 1.14.1  h5py 3.12.1
Date: Wed Jan 22 22:03:34 2025
PySCF version 2.7.0
PySCF path  /home/junjiey/anaconda3/envs/fftisdf/lib/python3.12/site-packages/pyscf

[ENV] PYSCF_TMPDIR /central/scratch/yangjunjie//fftdf-supercell/46923358/
[ENV] PYSCF_MAX_MEMORY 245760
[ENV] PYSCF_EXT_PATH /home/junjiey/packages/pyscf-forge/pyscf-forge-yangjunjie-non-orth/
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 32
[INPUT] num. electrons = 264
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstorm
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Cu     1.927800000000   1.927800000000   1.590250000000 AA    3.643014022937   3.643014022937   3.005136969590 Bohr   0.0
[INPUT]  2 Cu     5.783400000000   5.783400000000   1.590250000000 AA   10.929042068810  10.929042068810   3.005136969590 Bohr   0.0
[INPUT]  3 Cu     1.927800000000   5.783400000000   1.590250000000 AA    3.643014022937  10.929042068810   3.005136969590 Bohr   0.0
[INPUT]  4 Cu     5.783400000000   1.927800000000   1.590250000000 AA   10.929042068810   3.643014022937   3.005136969590 Bohr   0.0
[INPUT]  5 O      1.927800000000   3.855600000000   1.590250000000 AA    3.643014022937   7.286028045873   3.005136969590 Bohr   0.0
[INPUT]  6 O      3.855600000000   5.783400000000   1.590250000000 AA    7.286028045873  10.929042068810   3.005136969590 Bohr   0.0
[INPUT]  7 O      5.783400000000   3.855600000000   1.590250000000 AA   10.929042068810   7.286028045873   3.005136969590 Bohr   0.0
[INPUT]  8 O      3.855600000000   1.927800000000   1.590250000000 AA    7.286028045873   3.643014022937   3.005136969590 Bohr   0.0
[INPUT]  9 O      0.000000000000   1.927800000000   1.590250000000 AA    0.000000000000   3.643014022937   3.005136969590 Bohr   0.0
[INPUT] 10 O      1.927800000000   7.711200000000   1.590250000000 AA    3.643014022937  14.572056091746   3.005136969590 Bohr   0.0
[INPUT] 11 O      7.711200000000   5.783400000000   1.590250000000 AA   14.572056091746  10.929042068810   3.005136969590 Bohr   0.0
[INPUT] 12 O      5.783400000000   0.000000000000   1.590250000000 AA   10.929042068810   0.000000000000   3.005136969590 Bohr   0.0
[INPUT] 13 Ca     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] 14 Ca     3.855600000000   3.855600000000   0.000000000000 AA    7.286028045873   7.286028045873   0.000000000000 Bohr   0.0
[INPUT] 15 Ca     7.711200000000   3.855600000000   0.000000000000 AA   14.572056091746   7.286028045873   0.000000000000 Bohr   0.0
[INPUT] 16 Ca     3.855600000000   7.711200000000   0.000000000000 AA    7.286028045873  14.572056091746   0.000000000000 Bohr   0.0
[INPUT] 17 Cu     1.927800000000   1.927800000000   4.770750000000 AA    3.643014022937   3.643014022937   9.015410908769 Bohr   0.0
[INPUT] 18 Cu     5.783400000000   5.783400000000   4.770750000000 AA   10.929042068810  10.929042068810   9.015410908769 Bohr   0.0
[INPUT] 19 Cu     1.927800000000   5.783400000000   4.770750000000 AA    3.643014022937  10.929042068810   9.015410908769 Bohr   0.0
[INPUT] 20 Cu     5.783400000000   1.927800000000   4.770750000000 AA   10.929042068810   3.643014022937   9.015410908769 Bohr   0.0
[INPUT] 21 O      1.927800000000   3.855600000000   4.770750000000 AA    3.643014022937   7.286028045873   9.015410908769 Bohr   0.0
[INPUT] 22 O      3.855600000000   5.783400000000   4.770750000000 AA    7.286028045873  10.929042068810   9.015410908769 Bohr   0.0
[INPUT] 23 O      5.783400000000   3.855600000000   4.770750000000 AA   10.929042068810   7.286028045873   9.015410908769 Bohr   0.0
[INPUT] 24 O      3.855600000000   1.927800000000   4.770750000000 AA    7.286028045873   3.643014022937   9.015410908769 Bohr   0.0
[INPUT] 25 O      0.000000000000   1.927800000000   4.770750000000 AA    0.000000000000   3.643014022937   9.015410908769 Bohr   0.0
[INPUT] 26 O      1.927800000000   7.711200000000   4.770750000000 AA    3.643014022937  14.572056091746   9.015410908769 Bohr   0.0
[INPUT] 27 O      7.711200000000   5.783400000000   4.770750000000 AA   14.572056091746  10.929042068810   9.015410908769 Bohr   0.0
[INPUT] 28 O      5.783400000000   0.000000000000   4.770750000000 AA   10.929042068810   0.000000000000   9.015410908769 Bohr   0.0
[INPUT] 29 Ca     0.000000000000   0.000000000000   3.180500000000 AA    0.000000000000   0.000000000000   6.010273939179 Bohr   0.0
[INPUT] 30 Ca     3.855600000000   3.855600000000   3.180500000000 AA    7.286028045873   7.286028045873   6.010273939179 Bohr   0.0
[INPUT] 31 Ca     7.711200000000   3.855600000000   3.180500000000 AA   14.572056091746   7.286028045873   6.010273939179 Bohr   0.0
[INPUT] 32 Ca     3.855600000000   7.711200000000   3.180500000000 AA    7.286028045873  14.572056091746   6.010273939179 Bohr   0.0

nuclear repulsion = -732.906017894692
number of shells = 72
number of NR pGTOs = 944
number of NR cGTOs = 176
basis = gth-szv-molopt-sr
ecp = {}
CPU time:         5.25
lattice vectors  a1 [14.572056092, 0.000000000, 0.000000000]
                 a2 [0.000000000, 14.572056092, 0.000000000]
                 a3 [0.000000000, 0.000000000, 12.020547878]
dimension = 3
low_dim_ft_type = None
Cell volume = 2552.5
rcut = 34.84447946911392 (nimgs = [3 3 3])
lattice sum = 585 cells
precision = 1e-12
pseudo = gth-pade
ke_cutoff = 20.0
    = [31 31 27] mesh (25947 PWs)
Initial guess from minao.

WARN: ke_cutoff/mesh (20 / [31 31 27]) is not enough for FFTDF to get integral accuracy 1e-12.
Coulomb integral error is ~ 7.6e+02 Eh.
Recommended ke_cutoff/mesh are 1385.53 / [247 247 203].

