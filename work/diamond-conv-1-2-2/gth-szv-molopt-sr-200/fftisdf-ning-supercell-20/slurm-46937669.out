OMP_NUM_THREADS = 64
MKL_NUM_THREADS = 1
PYSCF_MAX_MEMORY = 491520
TMPDIR = /central/scratch/yangjunjie//fftisdf-ning-supercell-20-diamond-conv-1-2-2-gth-szv-molopt-sr/46937669/
PYSCF_TMPDIR = /central/scratch/yangjunjie//fftisdf-ning-supercell-20-diamond-conv-1-2-2-gth-szv-molopt-sr/46937669/

/home/junjiey/anaconda3/envs/fftisdf/bin/python
2.7.0
1.14.1
1.26.4
LOADING ISDF BACKEND
NUM_THREADS   : 64
USE_NUMPY     : 0
USE_SCIPY     : 1
USE_TORCH     : 0
USE_TORCH_GPU : 0
#INFO: **** input file is /central/home/junjiey/work/fftisdf-benchmark/work/diamond-conv-1-2-2/gth-szv-molopt-sr-200/fftisdf-ning-supercell-20/main.py ****
import os, sys
import numpy, scipy
import pyscf

TMPDIR = os.getenv("TMPDIR", None)
DATA_PATH = os.getenv("DATA_PATH", None)
PYSCF_MAX_MEMORY = os.getenv("PYSCF_MAX_MEMORY", 4000)
PYSCF_MAX_MEMORY = int(PYSCF_MAX_MEMORY)

try:
    from pyscf.lib import generate_pickle_methods
    getstate, setstate = generate_pickle_methods(
        excludes=(
            '_isdf_to_save', 
            '_isdf', 
            'buffer_fft',
            'buffer_cpu', 
            'buffer_gpu', 
            'buffer',
            'cell', 
            'prim_cell',
            '_swapfile',
        )
    )   
except ImportError:
    import sys 
    sys.stderr.write("pyscf.lib.generate_pickle_methods is not available, ISDF will not support pickle\n")
    def raise_error(*args, **kwargs):
        raise NotImplementedError("ISDF does not support pickle")
    getstate = setstate = raise_error

from pyscf.isdf import isdf_local
class ISDF_Local(isdf_local.ISDF_Local):
    __getstate__ = getstate
    __setstate__ = setstate

class ISDF(object):
    cell = None
    group = None

    kpts = None
    kmesh = None
    c0 = None
    verbose = 10

    _isdf = None
    _isdf_to_save = None
    
    def __init__(self, cell=None, kpts=None):
        assert kpts is None
        self.cell = cell
        self.kpts = kpts

    def build(self):
        cell = self.cell.copy(deep=True)

        group = self.group
        assert group is not None

        direct = False
        c0 = self.c0
        rela_qr = 1e-3
        aoR_cutoff = 1e-8
        build_V_K_bunchsize = 512
        with_robust_fitting = False

        from pyscf.lib import logger
        from pyscf.lib.logger import perf_counter
        from pyscf.lib.logger import process_clock
        t0 = (process_clock(), perf_counter())
        log = logger.new_logger(cell, 10)
        log.info("ISDF module: %s" % isdf_local.__file__)

        isdf_obj = ISDF_Local(
            cell, limited_memory=True, direct=direct,
            with_robust_fitting=with_robust_fitting,
            build_V_K_bunchsize=build_V_K_bunchsize,
        )

        isdf_obj.verbose = 10
        log.info("c0 = %6.2f" % c0)

        isdf_obj.build(c=c0, rela_cutoff=rela_qr, group=group)

        nip = isdf_obj.naux
        log.info(
            "Number of interpolation points = %d, effective CISDF = %6.2f",
            nip, nip / isdf_obj.nao
        )
        log.timer("ISDF build", *t0)

        import pickle
        with open(self._isdf, "wb") as f:
            pickle.dump(isdf_obj, f)
            log.debug("finished saving to %s", self._isdf)

        isdf_obj._isdf = self._isdf
        isdf_obj._isdf_to_save = self._isdf
        return isdf_obj

def main(args):
    from utils import cell_from_poscar
    path = os.path.join(DATA_PATH, args.cell)
    assert os.path.exists(path), "Cell file not found: %s" % path

    c = cell_from_poscar(path)
    c.basis = args.basis
    c.pseudo = args.pseudo
    c.verbose = 0
    c.unit = 'aa'
    # c.exp_to_discard = 0.1
    # c.exp_to_discard = 0.0
    c.max_memory = PYSCF_MAX_MEMORY
    c.ke_cutoff = args.ke_cutoff
    c.build(dump_input=False)

    kmesh = [int(x) for x in args.kmesh.split("-")]
    kmesh = numpy.array(kmesh)
    kpts = c.get_kpts(kmesh)

    pcell = c.copy(deep=True)

    natm = len(pcell.atom)
    atm = []
    for ia in range(natm):
        s = pcell.atom_symbol(ia)
        x = pcell.atom_coord(ia, unit='A')
        atm.append([s, x])

    from pyscf.lib.parameters import BOHR
    lvx = pcell.lattice_vectors() * BOHR

    from pyscf.isdf.isdf_tools_cell import build_supercell_with_partition
    scell, group = build_supercell_with_partition(
        atm, lvx, spin=0, charge=0, mesh=None, Ls=kmesh,
        partition=None, basis=args.basis,
        pseudo=args.pseudo, ke_cutoff=args.ke_cutoff,
        max_memory=PYSCF_MAX_MEMORY, 
        precision=1e-12, 
        use_particle_mesh_ewald=True,
        verbose=4,
    )

    from utils import get_jk_time
    df_obj = ISDF(scell)
    df_obj.group = group
    df_obj.c0 = args.c0
    df_obj.verbose = 10
    df_obj.kmesh = kmesh
    df_obj._isdf = os.path.join(TMPDIR, "isdf.chk")

    from utils import get_jk_time
    kmesh = None
    get_jk_time(scell, kmesh=kmesh, df_obj=df_obj, tmp=df_obj._isdf)

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--cell", type=str, default="diamond-prim.vasp")
    parser.add_argument("--kmesh", type=str, default="2-2-2")
    parser.add_argument("--c0", type=float, default=20.0)
    parser.add_argument("--ke_cutoff", type=float, default=40)
    parser.add_argument("--basis", type=str, default="gth-dzvp-molopt-sr")
    parser.add_argument("--pseudo", type=str, default="gth-pade")

    args = parser.parse_args()
    main(args)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='hpc-52-20.cm.cluster', release='5.14.0-362.24.1.el9_3.x86_64', version='#1 SMP PREEMPT_DYNAMIC Thu Feb 15 07:18:13 EST 2024', machine='x86_64')  Threads 64
Python 3.12.3 | packaged by conda-forge | (main, Apr 15 2024, 18:38:13) [GCC 12.3.0]
numpy 1.26.4  scipy 1.14.1  h5py 3.12.1
Date: Thu Jan 23 20:04:02 2025
PySCF version 2.7.0
PySCF path  /home/junjiey/anaconda3/envs/fftisdf/lib/python3.12/site-packages/pyscf

[ENV] PYSCF_TMPDIR /central/scratch/yangjunjie//fftisdf-ning-supercell-20-diamond-conv-1-2-2-gth-szv-molopt-sr/46937669/
[ENV] PYSCF_MAX_MEMORY 491520
[ENV] PYSCF_EXT_PATH /home/junjiey/packages/pyscf-forge/pyscf-forge-yangjunjie-non-orth/
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 32
[INPUT] num. electrons = 128
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstorm
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 C      0.000000000000   0.000000000000   1.780372554545 AA    0.000000000000   0.000000000000   3.364416527783 Bohr   0.0
[INPUT]  2 C      0.890186277273   0.890186277273   2.670558831818 AA    1.682208263891   1.682208263891   5.046624791674 Bohr   0.0
[INPUT]  3 C     -0.000000000000   1.780372554545   0.000000000000 AA   -0.000000000000   3.364416527783   0.000000000000 Bohr   0.0
[INPUT]  4 C      0.890186277273   2.670558831818   0.890186277273 AA    1.682208263891   5.046624791674   1.682208263891 Bohr   0.0
[INPUT]  5 C      1.780372554545   0.000000000000   0.000000000000 AA    3.364416527783   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  6 C      2.670558831818   0.890186277273   0.890186277273 AA    5.046624791674   1.682208263891   1.682208263891 Bohr   0.0
[INPUT]  7 C      1.780372554545   1.780372554545   1.780372554545 AA    3.364416527783   3.364416527783   3.364416527783 Bohr   0.0
[INPUT]  8 C      2.670558831818   2.670558831818   2.670558831818 AA    5.046624791674   5.046624791674   5.046624791674 Bohr   0.0
[INPUT]  9 C      0.000000000000   0.000000000000   5.341117663635 AA    0.000000000000   0.000000000000  10.093249583348 Bohr   0.0
[INPUT] 10 C      0.890186277273   0.890186277273   6.231303940908 AA    1.682208263891   1.682208263891  11.775457847239 Bohr   0.0
[INPUT] 11 C     -0.000000000000   1.780372554545   3.560745109090 AA   -0.000000000000   3.364416527783   6.728833055565 Bohr   0.0
[INPUT] 12 C      0.890186277273   2.670558831818   4.450931386363 AA    1.682208263891   5.046624791674   8.411041319457 Bohr   0.0
[INPUT] 13 C      1.780372554545   0.000000000000   3.560745109090 AA    3.364416527783   0.000000000000   6.728833055565 Bohr   0.0
[INPUT] 14 C      2.670558831818   0.890186277273   4.450931386363 AA    5.046624791674   1.682208263891   8.411041319457 Bohr   0.0
[INPUT] 15 C      1.780372554545   1.780372554545   5.341117663635 AA    3.364416527783   3.364416527783  10.093249583348 Bohr   0.0
[INPUT] 16 C      2.670558831818   2.670558831818   6.231303940908 AA    5.046624791674   5.046624791674  11.775457847239 Bohr   0.0
[INPUT] 17 C     -0.000000000000   3.560745109090   1.780372554545 AA   -0.000000000000   6.728833055565   3.364416527783 Bohr   0.0
[INPUT] 18 C      0.890186277273   4.450931386363   2.670558831818 AA    1.682208263891   8.411041319457   5.046624791674 Bohr   0.0
[INPUT] 19 C     -0.000000000000   5.341117663635   0.000000000000 AA   -0.000000000000  10.093249583348   0.000000000000 Bohr   0.0
[INPUT] 20 C      0.890186277273   6.231303940908   0.890186277273 AA    1.682208263891  11.775457847239   1.682208263891 Bohr   0.0
[INPUT] 21 C      1.780372554545   3.560745109090   0.000000000000 AA    3.364416527783   6.728833055565   0.000000000000 Bohr   0.0
[INPUT] 22 C      2.670558831818   4.450931386363   0.890186277273 AA    5.046624791674   8.411041319457   1.682208263891 Bohr   0.0
[INPUT] 23 C      1.780372554545   5.341117663635   1.780372554545 AA    3.364416527783  10.093249583348   3.364416527783 Bohr   0.0
[INPUT] 24 C      2.670558831818   6.231303940908   2.670558831818 AA    5.046624791674  11.775457847239   5.046624791674 Bohr   0.0
[INPUT] 25 C     -0.000000000000   3.560745109090   5.341117663635 AA   -0.000000000000   6.728833055565  10.093249583348 Bohr   0.0
[INPUT] 26 C      0.890186277273   4.450931386363   6.231303940908 AA    1.682208263891   8.411041319457  11.775457847239 Bohr   0.0
[INPUT] 27 C     -0.000000000000   5.341117663635   3.560745109090 AA   -0.000000000000  10.093249583348   6.728833055565 Bohr   0.0
[INPUT] 28 C      0.890186277273   6.231303940908   4.450931386363 AA    1.682208263891  11.775457847239   8.411041319457 Bohr   0.0
[INPUT] 29 C      1.780372554545   3.560745109090   3.560745109090 AA    3.364416527783   6.728833055565   6.728833055565 Bohr   0.0
[INPUT] 30 C      2.670558831818   4.450931386363   4.450931386363 AA    5.046624791674   8.411041319457   8.411041319457 Bohr   0.0
[INPUT] 31 C      1.780372554545   5.341117663635   5.341117663635 AA    3.364416527783  10.093249583348  10.093249583348 Bohr   0.0
[INPUT] 32 C      2.670558831818   6.231303940908   6.231303940908 AA    5.046624791674  11.775457847239  11.775457847239 Bohr   0.0

nuclear repulsion = -204.941969568084
number of shells = 64
number of NR pGTOs = 640
number of NR cGTOs = 128
basis = gth-szv-molopt-sr
ecp = {}
CPU time:        10.84
lattice vectors  a1 [6.728833056, 0.000000000, 0.000000000]
                 a2 [-0.000000000, 13.457666111, 0.000000000]
                 a3 [0.000000000, 0.000000000, 13.457666111]
dimension = 3
low_dim_ft_type = None
Cell volume = 1218.65
rcut = 23.683348913310077 (nimgs = [4 2 2])
lattice sum = 419 cells
precision = 1e-12
pseudo = gth-pade
ke_cutoff = 200.0
    = [45 87 87] mesh (340605 PWs)
Initial guess from minao.
ISDF module: /home/junjiey/packages/pyscf-forge/pyscf-forge-yangjunjie-non-orth/pyscf/isdf/isdf_local.py
ISDF: mol.ke_cutoff = 200.000000
ISDF: mol.natm      = 32
ISDF: mol.nao       = 128
c0 =  20.00
       get_partition wall time:     1.664114 CPU time:     7.227927
len of partition[   0] =  10655
len of partition[   1] =  10604
len of partition[   2] =  10640
len of partition[   3] =  10578
len of partition[   4] =  10554
len of partition[   5] =  10757
len of partition[   6] =  10607
len of partition[   7] =  10743
len of partition[   8] =  10640
len of partition[   9] =  10747
len of partition[  10] =  10609
len of partition[  11] =  10746
len of partition[  12] =  10701
len of partition[  13] =  10588
len of partition[  14] =  10607
len of partition[  15] =  10589
len of partition[  16] =  10594
len of partition[  17] =  10728
len of partition[  18] =  10627
len of partition[  19] =  10730
len of partition[  20] =  10701
len of partition[  21] =  10584
len of partition[  22] =  10607
len of partition[  23] =  10588
len of partition[  24] =  10607
len of partition[  25] =  10594
len of partition[  26] =  10564
len of partition[  27] =  10583
len of partition[  28] =  10674
len of partition[  29] =  10731
len of partition[  30] =  10607
len of partition[  31] =  10721
             get_aoR wall time:     1.295844 CPU time:    81.231958
In _build_buffer: ISDF Local size of buffer = 509.328 MB
 ---------- In pyscf.isdf.isdf_local.select_IP_local_atm ----------
select_IP_local_atm: atm_begin =    0, atm_end =   32
select_IP_local_atm: npt_found =  136
select_IP_local_atm: npt_found =  145
select_IP_local_atm: npt_found =  147
select_IP_local_atm: npt_found =  135
select_IP_local_atm: npt_found =  140
select_IP_local_atm: npt_found =  141
select_IP_local_atm: npt_found =  134
select_IP_local_atm: npt_found =  142
select_IP_local_atm: npt_found =  142
select_IP_local_atm: npt_found =  140
select_IP_local_atm: npt_found =  137
select_IP_local_atm: npt_found =  138
select_IP_local_atm: npt_found =  139
select_IP_local_atm: npt_found =  138
select_IP_local_atm: npt_found =  137
select_IP_local_atm: npt_found =  142
select_IP_local_atm: npt_found =  139
select_IP_local_atm: npt_found =  133
select_IP_local_atm: npt_found =  149
select_IP_local_atm: npt_found =  141
select_IP_local_atm: npt_found =  142
select_IP_local_atm: npt_found =  142
select_IP_local_atm: npt_found =  140
select_IP_local_atm: npt_found =  139
select_IP_local_atm: npt_found =  135
select_IP_local_atm: npt_found =  135
select_IP_local_atm: npt_found =  145
select_IP_local_atm: npt_found =  143
select_IP_local_atm: npt_found =  137
select_IP_local_atm: npt_found =  135
select_IP_local_atm: npt_found =  134
select_IP_local_atm: npt_found =  133
select_IP_local_step1 wall time:     2.524893 CPU time:   160.955100
 build_aoRg_possible wall time:     0.027031 CPU time:     1.759870
select_IP_local_step2 wall time:     0.000151 CPU time:     0.000164
select_IP_local_step3 wall time:     0.001483 CPU time:     0.064338
Memory usage for aoR  :    332.653 MB
Memory usage for aoRg :      4.382 MB
            build_IP wall time:     2.553558 CPU time:   162.779472
build_aux_basis_local wall time:     0.796345 CPU time:    50.422834
 ---------- In pyscf.isdf.isdf_local.build_V_W_local ----------
Memory usage for V:      0.000 MB
Memory usage for W:    151.421 MB
     build_V_W_local wall time:    62.654277 CPU time:   197.822726
Number of interpolation points = 4455, effective CISDF =  34.80
    CPU time for ISDF build    508.74 sec, wall time     69.11 sec
/home/junjiey/anaconda3/envs/fftisdf/lib/python3.12/site-packages/pyscf/gto/mole.py:1294: UserWarning: Function mol.dumps drops attribute a because it is not JSON-serializable
  warnings.warn(msg)
/home/junjiey/anaconda3/envs/fftisdf/lib/python3.12/site-packages/pyscf/gto/mole.py:1294: UserWarning: Function mol.dumps drops attribute _mesh because it is not JSON-serializable
  warnings.warn(msg)
finished saving to /central/scratch/yangjunjie//fftisdf-ning-supercell-20-diamond-conv-1-2-2-gth-szv-molopt-sr/46937669/isdf.chk
      isdf_local_eri wall time:    28.578467 CPU time:  1470.011251
